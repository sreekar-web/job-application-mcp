{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
    <!-- Page Title -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4 fw-bold gradient-text">
                <i class="fas fa-tachometer-alt me-3"></i>Dashboard
            </h1>
            <p class="text-muted">Real-time job application tracking and analytics</p>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4" id="stats-cards">
        <!-- Loaded via JavaScript -->
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <div class="col-lg-6 mb-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-gradient-teal border-0">
                    <h5 class="card-title text-white mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Application Status Distribution
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="statusChart" height="80"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-gradient-orange border-0">
                    <h5 class="card-title text-white mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Companies Overview
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="companiesChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Follow-ups Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-gradient-pink border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title text-white mb-0">
                            <i class="fas fa-bell me-2"></i>Follow-ups Needed
                        </h5>
                        <span class="badge bg-light text-dark" id="followup-count">0</span>
                    </div>
                </div>
                <div class="card-body">
                    <div id="followups-list">
                        <p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Applications Section -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-gradient-blue border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title text-white mb-0">
                            <i class="fas fa-clock me-2"></i>Recent Applications
                        </h5>
                        <a href="/applications" class="btn btn-sm btn-light">View All</a>
                    </div>
                </div>
                <div class="card-body">
                    <div id="recent-applications">
                        <p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0">
            <div class="modal-header bg-gradient-blue text-white border-0">
                <h5 class="modal-title">Update Status</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="statusForm">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">New Status</label>
                        <select class="form-select" id="newStatus" required>
                            <option value="">Select a status...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Notes (Optional)</label>
                        <textarea class="form-control" id="statusNotes" rows="3" placeholder="Add any notes about this status update..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateStatus()">Update Status</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const statusModal = new bootstrap.Modal(document.getElementById('statusModal'));
    let currentJobId = null;

    // Load dashboard data on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadStats();
        loadFollowups();
        loadRecentApplications();
    });

    function loadStats() {
        fetch('/api/stats')
            .then(response => response.json())
            .then(data => {
                renderStatsCards(data);
                renderCharts(data);
            })
            .catch(error => console.error('Error loading stats:', error));
    }

    function renderStatsCards(data) {
        const cards = [
            {
                title: 'Total Applications',
                value: data.total_applications,
                icon: 'fa-briefcase',
                color: 'primary',
                gradient: 'gradient-blue'
            },
            {
                title: 'Submitted',
                value: data.submitted,
                icon: 'fa-paper-plane',
                color: 'info',
                gradient: 'gradient-teal'
            },
            {
                title: 'Interviews',
                value: data.interviews,
                icon: 'fa-video',
                color: 'warning',
                gradient: 'gradient-orange'
            },
            {
                title: 'Offers',
                value: data.offers,
                icon: 'fa-star',
                color: 'success',
                gradient: 'gradient-green'
            },
            {
                title: 'Pending Follow-up',
                value: data.pending || 0,
                icon: 'fa-hourglass-end',
                color: 'danger',
                gradient: 'gradient-pink'
            },
            {
                title: 'Success Rate',
                value: data.success_rate.toFixed(1) + '%',
                icon: 'fa-chart-line',
                color: 'success',
                gradient: 'gradient-green'
            }
        ];

        const html = cards.map(card => `
            <div class="col-md-6 col-lg-4 col-xl-2 mb-3">
                <div class="card stat-card shadow-sm border-0 h-100">
                    <div class="card-body text-center">
                        <div class="stat-icon mb-3 ${card.gradient}">
                            <i class="fas ${card.icon}"></i>
                        </div>
                        <p class="text-muted text-uppercase small fw-semibold">${card.title}</p>
                        <h3 class="stat-value fw-bold">${card.value}</h3>
                    </div>
                </div>
            </div>
        `).join('');

        document.getElementById('stats-cards').innerHTML = html;
    }

    function renderCharts(data) {
        // Status Distribution Pie Chart
        const statusCtx = document.getElementById('statusChart').getContext('2d');
        const statusColors = {
            'SUBMITTED': '#667eea',
            'PENDING_USER_INPUT': '#f39c12',
            'VIEWED': '#16a085',
            'INTERVIEW': '#3498db',
            'OFFER': '#2ecc71',
            'ACCEPTED': '#27ae60',
            'REJECTED': '#e74c3c',
            'SAVED': '#95a5a6'
        };

        const statusLabels = Object.keys(data.status_counts);
        const statusValues = Object.values(data.status_counts);
        const statusChartColors = statusLabels.map(label => statusColors[label] || '#95a5a6');

        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: statusLabels,
                datasets: [{
                    data: statusValues,
                    backgroundColor: statusChartColors,
                    borderColor: 'white',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { font: { size: 12 }, padding: 15 }
                    }
                }
            }
        });

        // Companies Bar Chart (top 10)
        const companies = Object.entries(data.company_count)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);

        const companiesCtx = document.getElementById('companiesChart').getContext('2d');
        new Chart(companiesCtx, {
            type: 'bar',
            data: {
                labels: companies.map(c => c[0]),
                datasets: [{
                    label: 'Applications',
                    data: companies.map(c => c[1]),
                    backgroundColor: [
                        '#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe',
                        '#43e97b', '#fa709a', '#fee140', '#30b0fe', '#ff006e'
                    ],
                    borderRadius: 5,
                    borderWidth: 0
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { beginAtZero: true, ticks: { stepSize: 1 } }
                }
            }
        });
    }

    function loadFollowups() {
        fetch('/api/followups')
            .then(response => response.json())
            .then(data => {
                document.getElementById('followup-count').textContent = data.length;
                renderFollowups(data);
            })
            .catch(error => console.error('Error loading followups:', error));
    }

    function renderFollowups(followups) {
        if (followups.length === 0) {
            document.getElementById('followups-list').innerHTML = '<p class="text-success"><i class="fas fa-check-circle"></i> No follow-ups needed!</p>';
            return;
        }

        const html = followups.slice(0, 5).map(app => `
            <div class="followup-item mb-3 p-3 border-start border-4 border-danger bg-danger bg-opacity-10 rounded">
                <div class="row">
                    <div class="col-md-8">
                        <h6 class="fw-semibold mb-1">${app.company} - ${app.role}</h6>
                        <p class="text-muted small mb-1">
                            <i class="fas fa-calendar"></i> Submitted: ${new Date(app.submitted_at).toLocaleDateString()}
                        </p>
                        <p class="text-danger small fw-semibold">
                            <i class="fas fa-exclamation-circle"></i> ${app.days_overdue} days overdue
                        </p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <button class="btn btn-sm btn-outline-danger" onclick="openStatusModal('${app.job_id}')">
                            <i class="fas fa-edit"></i> Update
                        </button>
                    </div>
                </div>
            </div>
        `).join('');

        document.getElementById('followups-list').innerHTML = html;
    }

    function loadRecentApplications() {
        fetch('/api/applications?limit=5')
            .then(response => response.json())
            .then(data => {
                renderRecentApplications(data);
            })
            .catch(error => console.error('Error loading applications:', error));
    }

    function renderRecentApplications(applications) {
        if (applications.length === 0) {
            document.getElementById('recent-applications').innerHTML = '<p class="text-muted">No applications yet</p>';
            return;
        }

        const html = `
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Company</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Applied</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${applications.map(app => `
                            <tr>
                                <td><strong>${app.company}</strong></td>
                                <td>${app.role}</td>
                                <td>
                                    <span class="badge badge-status status-${app.status.toLowerCase()}">
                                        ${app.status}
                                    </span>
                                </td>
                                <td>${new Date(app.submitted_at).toLocaleDateString()}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="openStatusModal('${app.job_id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;

        document.getElementById('recent-applications').innerHTML = html;
    }

    function openStatusModal(jobId) {
        currentJobId = jobId;
        
        // Load valid transitions
        fetch(`/api/valid-transitions/${jobId}`)
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('newStatus');
                select.innerHTML = '<option value="">Select a status...</option>' +
                    data.map(status => `<option value="${status}">${status}</option>`).join('');
            });

        statusModal.show();
    }

    function updateStatus() {
        const newStatus = document.getElementById('newStatus').value;
        const notes = document.getElementById('statusNotes').value;

        if (!newStatus) {
            alert('Please select a status');
            return;
        }

        fetch('/api/update-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                job_id: currentJobId,
                new_status: newStatus,
                notes: notes
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Status updated successfully!');
                    statusModal.hide();
                    document.getElementById('statusNotes').value = '';
                    loadStats();
                    loadFollowups();
                    loadRecentApplications();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating status');
            });
    }

    // Refresh data every 30 seconds
    setInterval(loadStats, 30000);
</script>
{% endblock %}
