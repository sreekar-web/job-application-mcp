{% extends "base.html" %}

{% block content %}
<div class="applications-container">
    <!-- Page Title & Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="display-4 fw-bold gradient-text mb-4">
                <i class="fas fa-list me-3"></i>All Applications
            </h1>

            <!-- Filter Row -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control form-control-lg" id="searchInput" 
                                   placeholder="Search by company or role..." 
                                   onkeyup="applyFilters()">
                        </div>
                        <div class="col-md-4">
                            <select class="form-select form-select-lg" id="statusFilter" onchange="applyFilters()">
                                <option value="">All Statuses</option>
                                <option value="SUBMITTED">Submitted</option>
                                <option value="PENDING_USER_INPUT">Pending User Input</option>
                                <option value="VIEWED">Viewed</option>
                                <option value="INTERVIEW">Interview</option>
                                <option value="OFFER">Offer</option>
                                <option value="ACCEPTED">Accepted</option>
                                <option value="REJECTED">Rejected</option>
                                <option value="SAVED">Saved</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                                <i class="fas fa-redo"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Applications Table -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="applicationsTable">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 20%">Company</th>
                                    <th style="width: 20%">Role</th>
                                    <th style="width: 15%">Status</th>
                                    <th style="width: 15%">Applied Date</th>
                                    <th style="width: 15%">Next Follow-up</th>
                                    <th style="width: 15%">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="applicationsBody">
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <i class="fas fa-spinner fa-spin"></i> Loading applications...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- No Results Message -->
                    <div id="noResults" style="display: none;" class="text-center py-5">
                        <i class="fas fa-inbox" style="font-size: 3rem; color: #ddd;"></i>
                        <p class="text-muted mt-3">No applications found matching your filters</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Row -->
    <div class="row mt-4">
        <div class="col-md-3">
            <div class="card stat-card shadow-sm border-0">
                <div class="card-body text-center">
                    <h4 id="totalCount" class="fw-bold">0</h4>
                    <p class="text-muted small">Total Applications</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card shadow-sm border-0">
                <div class="card-body text-center">
                    <h4 id="overdue-count" class="fw-bold text-danger">0</h4>
                    <p class="text-muted small">Overdue Follow-ups</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card shadow-sm border-0">
                <div class="card-body text-center">
                    <h4 id="pending-count" class="fw-bold text-warning">0</h4>
                    <p class="text-muted small">Pending Interviews</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card shadow-sm border-0">
                <div class="card-body text-center">
                    <h4 id="success-count" class="fw-bold text-success">0</h4>
                    <p class="text-muted small">Offers / Accepted</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content border-0">
            <div class="modal-header bg-gradient-blue text-white border-0">
                <h5 class="modal-title">Update Status</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="appDetails" class="mb-3 p-3 bg-light rounded">
                    <!-- App details populated by JS -->
                </div>
                <form id="statusForm">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">New Status</label>
                        <select class="form-select" id="newStatus" required>
                            <option value="">Select a status...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Notes (Optional)</label>
                        <textarea class="form-control" id="statusNotes" rows="3" placeholder="Add notes..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updateStatus()">Update Status</button>
            </div>
        </div>
    </div>
</div>

<!-- Timeline Modal -->
<div class="modal fade" id="timelineModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0">
            <div class="modal-header bg-gradient-teal text-white border-0">
                <h5 class="modal-title">Application Timeline</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="timeline-content">
                    <!-- Timeline loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const statusModal = new bootstrap.Modal(document.getElementById('statusModal'));
    const timelineModal = new bootstrap.Modal(document.getElementById('timelineModal'));
    let allApplications = [];
    let currentJobId = null;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadApplications();
        // Refresh every 60 seconds
        setInterval(loadApplications, 60000);
    });

    function loadApplications() {
        fetch('/api/applications')
            .then(response => response.json())
            .then(data => {
                allApplications = data;
                applyFilters();
            })
            .catch(error => console.error('Error loading applications:', error));
    }

    function applyFilters() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const status = document.getElementById('statusFilter').value;

        let filtered = allApplications.filter(app => {
            const matchesSearch = app.company.toLowerCase().includes(search) || 
                                 app.role.toLowerCase().includes(search);
            const matchesStatus = !status || app.status === status;
            return matchesSearch && matchesStatus;
        });

        renderApplications(filtered);
        updateStatistics(filtered);
    }

    function resetFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('statusFilter').value = '';
        applyFilters();
    }

    function renderApplications(applications) {
        const body = document.getElementById('applicationsBody');
        const noResults = document.getElementById('noResults');

        if (applications.length === 0) {
            body.innerHTML = '';
            noResults.style.display = 'block';
            return;
        }

        noResults.style.display = 'none';
        body.innerHTML = applications.map(app => `
            <tr class="align-middle">
                <td>
                    <strong class="text-dark">${app.company}</strong>
                </td>
                <td>${app.role}</td>
                <td>
                    <span class="badge badge-status status-${app.status.toLowerCase()}" title="${app.status}">
                        ${app.status.replace(/_/g, ' ')}
                    </span>
                </td>
                <td>
                    <small>${new Date(app.submitted_at).toLocaleDateString()}</small>
                </td>
                <td>
                    ${app.next_followup_at ? `
                        <small class="${app.days_overdue > 0 ? 'text-danger fw-semibold' : ''}">
                            ${new Date(app.next_followup_at).toLocaleDateString()}
                            ${app.days_overdue > 0 ? `<i class="fas fa-exclamation-circle"></i>` : ''}
                        </small>
                    ` : '<small class="text-muted">-</small>'}
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" title="Update Status" 
                            onclick="openStatusModal('${app.job_id}', '${app.company}', '${app.role}', '${app.status}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-info" title="View Timeline" 
                            onclick="openTimeline('${app.job_id}')">
                        <i class="fas fa-history"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function updateStatistics(applications) {
        const total = applications.length;
        const overdue = applications.filter(app => app.days_overdue > 0).length;
        const pending = applications.filter(app => app.status === 'INTERVIEW').length;
        const success = applications.filter(app => ['OFFER', 'ACCEPTED'].includes(app.status)).length;

        document.getElementById('totalCount').textContent = total;
        document.getElementById('overdue-count').textContent = overdue;
        document.getElementById('pending-count').textContent = pending;
        document.getElementById('success-count').textContent = success;
    }

    function openStatusModal(jobId, company, role, currentStatus) {
        currentJobId = jobId;

        document.getElementById('appDetails').innerHTML = `
            <strong>${company}</strong> - ${role}<br>
            <small class="text-muted">Current Status: <span class="badge badge-status status-${currentStatus.toLowerCase()}">${currentStatus}</span></small>
        `;

        // Load valid transitions
        fetch(`/api/valid-transitions/${jobId}`)
            .then(response => response.json())
            .then(data => {
                const select = document.getElementById('newStatus');
                select.innerHTML = '<option value="">Select a status...</option>' +
                    data.map(status => `<option value="${status}">${status.replace(/_/g, ' ')}</option>`).join('');
            });

        statusModal.show();
    }

    function updateStatus() {
        const newStatus = document.getElementById('newStatus').value;
        const notes = document.getElementById('statusNotes').value;

        if (!newStatus) {
            alert('Please select a status');
            return;
        }

        fetch('/api/update-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                job_id: currentJobId,
                new_status: newStatus,
                notes: notes
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Status updated successfully!');
                    statusModal.hide();
                    document.getElementById('statusNotes').value = '';
                    loadApplications();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating status');
            });
    }

    function openTimeline(jobId) {
        fetch(`/api/timeline/${jobId}`)
            .then(response => response.json())
            .then(data => {
                const html = `
                    <div class="timeline">
                        ${data.status_history.map((entry, index) => `
                            <div class="timeline-item mb-3">
                                <div class="timeline-marker" style="background: ${getStatusColor(entry.status)}">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="timeline-content ps-4">
                                    <h6 class="fw-semibold mb-1">${entry.status.replace(/_/g, ' ')}</h6>
                                    <small class="text-muted d-block">${new Date(entry.timestamp).toLocaleString()}</small>
                                    ${entry.notes ? `<small class="text-muted d-block mt-1"><em>${entry.notes}</em></small>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                document.getElementById('timeline-content').innerHTML = html;
                timelineModal.show();
            })
            .catch(error => {
                console.error('Error loading timeline:', error);
                alert('Error loading timeline');
            });
    }

    function getStatusColor(status) {
        const colors = {
            'SUBMITTED': '#667eea',
            'PENDING_USER_INPUT': '#f39c12',
            'VIEWED': '#16a085',
            'INTERVIEW': '#3498db',
            'OFFER': '#2ecc71',
            'ACCEPTED': '#27ae60',
            'REJECTED': '#e74c3c',
            'SAVED': '#95a5a6'
        };
        return colors[status] || '#95a5a6';
    }
</script>
{% endblock %}
